<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FX Portfolio - nano</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Courier New', monospace;
      background: #0a0e27;
      color: #00ff41;
      line-height: 1.3;
      padding: 15px;
      font-size: 11px;
    }
    .header {
      border-bottom: 2px solid #00ff41;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .header h1 {
      font-size: 1.5em;
      color: #00ff41;
      text-shadow: 0 0 10px #00ff41;
    }
    .header .timestamp {
      color: #888;
      font-size: 0.85em;
      margin-top: 3px;
    }
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 15px;
      border-bottom: 1px solid #333;
      padding-bottom: 8px;
      flex-wrap: wrap;
      font-size: 0.8em;
    }
    .tab {
      padding: 4px 10px;
      background: #1a1e3a;
      border: 1px solid #333;
      cursor: pointer;
      transition: all 0.3s;
      color: #888;
    }
    .tab:hover {
      background: #2a2e4a;
      border-color: #00ff41;
    }
    .tab.active {
      background: #00ff41;
      color: #0a0e27;
      border-color: #00ff41;
      font-weight: bold;
    }
    .tab-content {
      display: none;
      animation: fadeIn 0.3s;
    }
    .tab-content.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .section {
      background: #1a1e3a;
      border: 1px solid #333;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 4px;
    }
    .section h2 {
      color: #00ff41;
      font-size: 1.1em;
      margin-bottom: 10px;
      border-bottom: 1px solid #333;
      padding-bottom: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 8px 0;
      font-size: 0.95em;
    }
    th, td {
      padding: 4px 6px;
      text-align: left;
      border-bottom: 1px solid #333;
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th {
      color: #00ff41;
      font-weight: bold;
      position: sticky;
      top: 0;
      background: #1a1e3a;
      font-size: 0.9em;
    }
    td {
      color: #ccc;
    }
    .bullish { color: #00ff41; }
    .bearish { color: #ff4444; }
    .neutral { color: #888; }
    .csv-table-container {
      max-height: 500px;
      overflow-y: auto;
      overflow-x: auto;
      margin-top: 8px;
    }
    .loading {
      color: #888;
      text-align: center;
      padding: 30px;
      font-size: 0.9em;
    }
    .architecture-diagram {
      background: #0f1229;
      padding: 10px;
      border: 1px solid #333;
      border-radius: 4px;
      overflow-x: auto;
      font-family: monospace;
    }
    pre {
      color: #00ff41;
      font-size: 0.7em;
      line-height: 1.2;
      letter-spacing: 0;
    }
    .status-indicator {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .status-active { background: #00ff41; box-shadow: 0 0 4px #00ff41; }
    .status-inactive { background: #555; }
    .step-header {
      color: #888;
      font-size: 0.85em;
      margin-bottom: 8px;
    }
    .csv-download {
      float: right;
      color: #00ff41;
      text-decoration: none;
      font-size: 0.85em;
      border: 1px solid #00ff41;
      padding: 3px 8px;
      border-radius: 3px;
    }
    .csv-download:hover {
      background: #00ff41;
      color: #0a0e27;
    }
    .chart {
      margin: 15px 0;
      padding: 10px;
      background: #0f1229;
      border: 1px solid #333;
      border-radius: 4px;
    }
    .bar {
      display: flex;
      align-items: center;
      margin: 3px 0;
    }
    .bar-label {
      width: 60px;
      color: #888;
      font-size: 0.85em;
    }
    .bar-fill {
      height: 14px;
      background: #00ff41;
      margin-right: 8px;
      transition: width 0.3s;
    }
    .bar-value {
      color: #ccc;
      font-size: 0.85em;
    }
    .graph-node {
      cursor: pointer;
      transition: all 0.2s;
    }
    .graph-node:hover {
      opacity: 0.8;
      filter: brightness(1.3);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚ö° FX PORTFOLIO DASHBOARD</h1>
    <div class="timestamp">Last updated: <span id="lastUpdate"></span></div>
  </div>

  <div class="tabs" id="nav-tabs">
    <div class="tab active" onclick="showTab('overview')">OVERVIEW</div>
    <div class="tab" onclick="showTab('config')">CONFIG</div>
    <!-- Step tabs will be generated dynamically from config -->
    <div class="tab" onclick="showTab('tracking')">TRACKING</div>
  </div>

  <!-- OVERVIEW TAB -->
  <div id="overview" class="tab-content active">
    <div class="section">
      <h2>Pipeline Architecture</h2>

      <!-- Visual Dependency Graph -->
      <div id="dependency-graph" style="background:#0f1229; padding:20px; border:1px solid #333; border-radius:4px; margin-bottom:15px; overflow-x:auto;">
        <div class="loading">Loading dependency graph...</div>
      </div>

      <!-- Detailed Step Info -->
      <div id="pipeline-dependencies" style="background:#0f1229; padding:15px; border:1px solid #333; border-radius:4px;">
        <div class="loading">Loading pipeline configuration...</div>
      </div>
      <div style="margin-top:15px; padding:12px; background:#1a1e3a; border:1px solid #333; border-radius:4px;">
        <div style="color:#888; font-size:0.85em;">
          <strong style="color:#00ff41;">Legend:</strong>
          <div style="margin-top:8px; display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
            <div>üü¢ Safe to clear (regenerable)</div>
            <div>üî¥ Cumulative state (careful!)</div>
            <div>üí∞ LLM costs when regenerated</div>
            <div>‚ö†Ô∏è May not be re-fetchable</div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Pipeline Status</h2>
      <table>
        <tr>
          <th>Step</th>
          <th>Component</th>
          <th>Status</th>
          <th>Details</th>
        </tr>
        <tr>
          <td>1</td>
          <td><span class="status-indicator status-active"></span>EUR Pairs</td>
          <td class="bullish">Active</td>
          <td><span id="step1-count">-</span> records</td>
        </tr>
        <tr>
          <td>2</td>
          <td><span class="status-indicator status-active"></span>Indices</td>
          <td class="bullish">Active</td>
          <td><span id="step2-count">-</span> points</td>
        </tr>
        <tr>
          <td>3</td>
          <td><span class="status-indicator status-active"></span>News</td>
          <td class="bullish">Active</td>
          <td><span id="step3-count">-</span> articles</td>
        </tr>
        <tr>
          <td>4</td>
          <td><span class="status-indicator status-active"></span>Horizons</td>
          <td class="bullish">LLM</td>
          <td><span id="step4-count">-</span> analyzed</td>
        </tr>
        <tr>
          <td>5</td>
          <td><span class="status-indicator status-active"></span>Signals</td>
          <td class="bullish">Active</td>
          <td><span id="step5-count">-</span> signals</td>
        </tr>
        <tr>
          <td>6</td>
          <td><span class="status-indicator status-active"></span>Realization</td>
          <td class="bullish">Active</td>
          <td><span id="step6-count">-</span> checked</td>
        </tr>
        <tr>
          <td>7</td>
          <td><span class="status-indicator status-active"></span>Strategies</td>
          <td class="bullish">Active</td>
          <td><span id="step7-count">-</span> combos</td>
        </tr>
      </table>
    </div>
  </div>

  <!-- CONFIG TAB -->
  <div id="tracking" class="tab-content">
    <div class="section">
      <h2>Data Completeness by Date</h2>
      <p class="step-header">Record counts per step for each data date</p>

      <div id="step-counts-table" style="margin:20px 0; overflow-x:auto;">
        <p style="color:#888;">Loading data...</p>
      </div>
    </div>

    <div class="section">
      <h2>Pipeline Run Tracking</h2>
      <p class="step-header">Debug view: step durations, errors, and execution logs per run date</p>

      <div style="margin:20px 0;">
        <label for="tracking-date-selector" style="color:#ccc; font-size:0.9em;">Select Run Date:</label>
        <select id="tracking-date-selector" style="background:#1a1a1a; color:#00ff41; border:1px solid #333; padding:8px; margin:10px 0; font-size:1em; border-radius:4px; width:200px;">
          <option value="">Loading dates...</option>
        </select>
        <span id="tracking-summary" style="color:#888; font-size:0.9em; margin-left:15px;"></span>
      </div>

      <div id="tracking-content" style="color:#888; font-size:0.9em;">
        Select a date to view run tracking information.
      </div>

      <div id="tracking-steps" style="display:none; margin-top:20px;"></div>
    </div>
  </div>

  <div id="config" class="tab-content">
    <div class="section">
      <h2>System Configuration</h2>
      <p class="step-header">All configured modules are active (presence in config = active)</p>

      <div style="background:#1a1a1a; border:1px solid #333; border-radius:4px; padding:12px; margin:15px 0; color:#ccc; font-size:0.9em;">
        <strong style="color:#00ff41;">‚ÑπÔ∏è Configuration Design:</strong><br>
        ‚Ä¢ Each module+parameter combination has a unique ID<br>
        ‚Ä¢ <strong>All listed modules are active</strong> - no separate "active" flag<br>
        ‚Ä¢ Strategies reference specific estimator and generator IDs<br>
        ‚Ä¢ To add/remove: edit <code style="background:#0a0a0a; padding:2px 6px; border-radius:2px;">config/system_config.json</code>
      </div>

      <div id="config-loading" style="color:#888; margin:20px 0;">Loading configuration...</div>
      <div id="config-content"></div>
    </div>
  </div>

  <!-- STEP TABS -->
  <div id="step1" class="tab-content">
    <div class="section">
      <h2>Step 1: Exchange Rates (All Pairs) <a href="data/step1_exchange_rates_matrix.csv" class="csv-download" download>CSV</a></h2>
      <p class="step-header">All currency pair exchange rates (10√ó10 matrix)</p>
      <p style="color:#888; font-size:0.9em; margin-bottom:10px;">
        Each cell shows how much COLUMN currency you get for 1 ROW currency.<br>
        Example: Row=USD, Column=JPY shows USD/JPY rate (how many JPY per 1 USD).
      </p>

      <!-- Date Selector -->
      <div style="margin:20px 0;">
        <label for="step1-date-selector" style="color:#ccc; font-size:0.9em;">Select Date:</label>
        <select id="step1-date-selector" style="background:#1a1a1a; color:#00ff41; border:1px solid #333; padding:8px; margin:10px 0; font-size:1em; border-radius:4px; width:200px;">
          <option value="">Loading dates...</option>
        </select>
      </div>

      <div class="csv-table-container">
        <div class="loading" id="step1-loading">Loading...</div>
        <div id="step1-matrix" style="display:none; overflow-x:auto;">
          <p id="step1-date" style="color:#888; font-size:0.9em; margin-bottom:10px;"></p>
          <table id="step1-table" style="font-size:0.85em;">
            <!-- Table header and body generated dynamically from matrix data -->
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- TRADES TAB -->
  <script>
    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      if (tabName.startsWith('step')) loadCSV(tabName);
      if (tabName === 'tracking') {
        loadStepCountsTable();
        loadTrackingDates();
      }
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const values = [];
        let current = '';
        let inQuotes = false;
        for (let char of line) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());
        return headers.reduce((obj, header, i) => {
          obj[header] = values[i] || '';
          return obj;
        }, {});
      });
      return { headers, rows };
    }

    const loadedCSVs = {};
    const stepDataCache = {};  // Cache loaded data for filtering

    function populateDateFilter(step, rows) {
      // Extract unique dates from rows and populate the date filter dropdown
      const dateField = rows[0]?.date ? 'date' : (rows[0]?.timestamp ? 'timestamp' : null);
      if (!dateField) return;

      const dates = [...new Set(rows.map(r => {
        const val = r[dateField];
        // Extract just the date part if it's a timestamp
        return val.includes('T') ? val.split('T')[0] : val;
      }))].sort().reverse();

      const selector = document.getElementById(`${step}-date-filter`);
      if (!selector) return;

      selector.innerHTML = '<option value="">All Dates</option>' +
        dates.map(d => `<option value="${d}">${d}</option>`).join('');

      // Add change listener to filter table
      selector.addEventListener('change', (e) => {
        filterTableByDate(step, e.target.value);
      });
    }

    function filterTableByDate(step, selectedDate) {
      const cachedData = stepDataCache[step];
      if (!cachedData) return;

      const { headers, allRows } = cachedData;
      const tbody = document.getElementById(`${step}-tbody`);

      // Filter rows by selected date
      let filteredRows = allRows;
      if (selectedDate) {
        filteredRows = allRows.filter(row => {
          const dateVal = row.date || row.timestamp || '';
          const rowDate = dateVal.includes('T') ? dateVal.split('T')[0] : dateVal;
          return rowDate === selectedDate;
        });
      }

      // Re-render table with filtered rows
      if (step === 'step4') {
        // Special rendering for step4
        const keyColumns = ['currency', 'title', 'time_horizon', 'horizon_category', 'confidence', 'reasoning'];
        tbody.innerHTML = filteredRows.map(row => {
          return '<tr>' + keyColumns.map(h => {
            let value = row[h] || '';
            let displayValue = value;

            if (h === 'title' && value.length > 60) {
              displayValue = value.substring(0, 60) + '...';
            } else if (h === 'reasoning' && value.length > 80) {
              displayValue = value.substring(0, 80) + '...';
            }

            let className = '';
            if (h === 'time_horizon') {
              if (value === '1day') className = 'bearish';
              else if (value === '1week') className = 'neutral';
              else if (value === '1month') className = 'bullish';
            }

            return `<td class="${className}" title="${value}">${displayValue}</td>`;
          }).join('') + '</tr>';
        }).join('');

        // Update charts and summary for step4
        if (filteredRows.length > 0) {
          generateHorizonChart(filteredRows);
          generateHorizonSummary(filteredRows);
        }
      } else {
        // Default rendering
        tbody.innerHTML = filteredRows.map(row => {
          return '<tr>' + headers.map(h => {
            let value = row[h];
            let className = '';

            // Color text values
            if (value === 'bullish') className = 'bullish';
            else if (value === 'bearish') className = 'bearish';
            else if (value === 'neutral') className = 'neutral';
            else if (value === 'true') className = 'bullish';
            else if (value === 'false') className = 'bearish';

            // Color numeric signal values (column names ending in _signal)
            if (h.endsWith('_signal') && value) {
              const numVal = parseFloat(value);
              if (!isNaN(numVal)) {
                if (numVal > 0) className = 'bullish';
                else if (numVal < 0) className = 'bearish';
                else className = 'neutral';
              }
            }

            return `<td class="${className}" title="${value}">${value}</td>`;
          }).join('') + '</tr>';
        }).join('');
      }

      // Update count
      const countEl = document.getElementById(`${step}-count`);
      if (countEl) countEl.textContent = filteredRows.length;
    }

    function loadCSV(step) {
      if (loadedCSVs[step]) return;

      // Step 1 uses special matrix format
      if (step === 'step1') {
        loadExchangeRateMatrix();
        return;
      }

      const csvFile = {
        'step2': 'data/step2_indices.csv',
        'step3': 'data/step3_news.csv',
        'step4': 'data/step4_horizons.csv',
        'step5': 'data/step5_signals.csv',
        'step6': 'data/step6_realization.csv',
        'step7': 'data/step7_trades.csv',
        'step8': 'data/step8_strategies.csv'
      }[step];

      fetch(csvFile)
        .then(res => res.text())
        .then(text => {
          const { headers, rows } = parseCSV(text);
          const thead = document.getElementById(`${step}-thead`);
          const tbody = document.getElementById(`${step}-tbody`);
          const table = document.getElementById(`${step}-table`);
          const loading = document.getElementById(`${step}-loading`);

          // Special rendering for step4 (show only key columns, matching step5 order)
          if (step === 'step4') {
            const keyColumns = ['date', 'estimator_id', 'estimator_type', 'estimator_params', 'currency', 'title', 'url', 'published_at', 'time_horizon', 'horizon_category', 'confidence', 'reasoning'];
            thead.innerHTML = '<tr>' + keyColumns.map(h => `<th>${h}</th>`).join('') + '</tr>';
            tbody.innerHTML = rows.map(row => {
              return '<tr>' + keyColumns.map(h => {
                let value = row[h] || '';
                let displayValue = value;

                // Truncate long fields
                if (h === 'title' && value.length > 60) {
                  displayValue = value.substring(0, 60) + '...';
                } else if (h === 'reasoning' && value.length > 80) {
                  displayValue = value.substring(0, 80) + '...';
                } else if (h === 'estimator_params' && value.length > 40) {
                  displayValue = value.substring(0, 40) + '...';
                } else if (h === 'url' && value.length > 50) {
                  displayValue = value.substring(0, 50) + '...';
                } else if (h === 'published_at' && value.length > 16) {
                  displayValue = value.substring(0, 16) + '...';
                }

                // Color code horizons
                let className = '';
                if (h === 'time_horizon') {
                  if (value === '1day') className = 'bearish';  // Red for immediate
                  else if (value === '1week') className = 'neutral';
                  else if (value === '1month') className = 'bullish';  // Green for long-term
                }

                return `<td class="${className}" title="${value}">${displayValue}</td>`;
              }).join('') + '</tr>';
            }).join('');
          } else {
            // Default rendering for other steps
            thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            tbody.innerHTML = rows.map(row => {
              return '<tr>' + headers.map(h => {
                let value = row[h];
                let className = '';
                if (value === 'bullish') className = 'bullish';
                else if (value === 'bearish') className = 'bearish';
                else if (value === 'neutral') className = 'neutral';
                else if (value === 'true') className = 'bullish';
                else if (value === 'false') className = 'bearish';
                return `<td class="${className}" title="${value}">${value}</td>`;
              }).join('') + '</tr>';
            }).join('');
          }

          loading.style.display = 'none';
          table.style.display = 'table';
          loadedCSVs[step] = true;

          // Cache data for filtering
          stepDataCache[step] = { headers, allRows: rows };

          // Populate date filter
          populateDateFilter(step, rows);

          const countEl = document.getElementById(`${step}-count`);
          if (countEl) countEl.textContent = rows.length;

          // Generate charts
          if (step === 'step4' && rows.length > 0) {
            generateHorizonChart(rows);
            generateHorizonSummary(rows);
          } else if (step === 'step7' && rows.length > 0) {
            generateStrategyChart(rows);
          }
        })
        .catch(err => {
          document.getElementById(`${step}-loading`).textContent = 'Error: ' + err.message;
        });
    }

    function generateHorizonChart(rows) {
      // Count articles by horizon
      const horizonCounts = {};
      const horizonOrder = ['1day', '3day', '1week', '2week', '1month'];
      const horizonLabels = {
        '1day': '1 Day',
        '3day': '3 Days',
        '1week': '1 Week',
        '2week': '2 Weeks',
        '1month': '1 Month'
      };

      rows.forEach(row => {
        const horizon = row.time_horizon;
        horizonCounts[horizon] = (horizonCounts[horizon] || 0) + 1;
      });

      const chartDiv = document.getElementById('horizon-chart');
      const total = rows.length;
      const maxCount = Math.max(...Object.values(horizonCounts));

      chartDiv.innerHTML = horizonOrder.map(horizon => {
        const count = horizonCounts[horizon] || 0;
        const pct = total > 0 ? (count / total * 100).toFixed(1) : 0;
        const barWidth = maxCount > 0 ? (count / maxCount * 100) : 0;

        return `
          <div class="bar">
            <div class="bar-label">${horizonLabels[horizon]}</div>
            <div class="bar-fill" style="width:${barWidth}%; background:#00ff41;"></div>
            <div class="bar-value">${count} articles (${pct}%)</div>
          </div>
        `;
      }).join('');
    }

    function generateHorizonSummary(rows) {
      const summaryDiv = document.getElementById('step4-summary');

      // Calculate average confidence
      const avgConfidence = rows.reduce((sum, r) => sum + (parseFloat(r.confidence) || 0), 0) / rows.length;

      // Count by estimator
      const estimatorCounts = {};
      rows.forEach(r => {
        const est = r.estimator_id;
        estimatorCounts[est] = (estimatorCounts[est] || 0) + 1;
      });

      summaryDiv.innerHTML = `
        <div style="display:flex; gap:30px; flex-wrap:wrap; padding:15px; background:#0a0a0a; border-radius:5px;">
          <div>
            <strong style="color:#00ff41;">Total Articles:</strong> ${rows.length}
          </div>
          <div>
            <strong style="color:#00ff41;">Avg Confidence:</strong> ${avgConfidence.toFixed(2)}
          </div>
          <div>
            <strong style="color:#00ff41;">Estimator:</strong> ${Object.keys(estimatorCounts)[0] || 'N/A'}
          </div>
        </div>
      `;
      summaryDiv.style.display = 'block';
    }

    function generateStrategyChart(rows) {
      const chartDiv = document.getElementById('strategy-chart');
      const maxValue = Math.max(...rows.map(r => parseFloat(r.current_value) || 0));

      chartDiv.innerHTML = rows.map(row => {
        const value = parseFloat(row.current_value) || 0;
        const pct = (value / maxValue) * 100;
        const params = row.strategy_params.replace(/_/g, ' ');

        return `
          <div class="bar">
            <div class="bar-label">${params}</div>
            <div class="bar-fill" style="width:${pct}%"></div>
            <div class="bar-value">‚Ç¨${value.toLocaleString()}</div>
          </div>
        `;
      }).join('');
    }


    let step1AvailableDates = [];
    let step1CurrentDate = null;

    function loadStep1Dates() {
      // Get dates directly from the CSV file
      fetch('data/step1_exchange_rates_matrix.csv')
        .then(res => res.text())
        .then(csvText => {
          const lines = csvText.trim().split('\n');
          const dates = new Set();

          // Skip header and collect unique dates
          for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split(',');
            dates.add(parts[0]);
          }

          step1AvailableDates = Array.from(dates).sort().reverse();
          const latestDate = step1AvailableDates[0];

          const selector = document.getElementById('step1-date-selector');

          if (step1AvailableDates.length === 0) {
            selector.innerHTML = '<option value="">No dates available</option>';
            return;
          }

          // Populate selector (most recent first)
          selector.innerHTML = step1AvailableDates.map(d =>
            `<option value="${d}">${d}</option>`
          ).join('');

          // Set default to latest
          if (latestDate) {
            selector.value = latestDate;
            step1CurrentDate = latestDate;
          }

          // Add change listener
          selector.addEventListener('change', (e) => {
            step1CurrentDate = e.target.value;
            loadExchangeRateMatrix(step1CurrentDate);
          });

          // Load latest matrix by default
          if (step1CurrentDate) {
            loadExchangeRateMatrix(step1CurrentDate);
          }
        })
        .catch(err => {
          console.error('Error loading step1 dates:', err);
          document.getElementById('step1-date-selector').innerHTML = '<option value="">Error loading dates</option>';
        });
    }

    function loadExchangeRateMatrix(date) {
      const loading = document.getElementById('step1-loading');
      const matrixDiv = document.getElementById('step1-matrix');
      const table = document.getElementById('step1-table');
      const dateEl = document.getElementById('step1-date');

      loading.style.display = 'block';
      loading.textContent = 'Loading...';
      matrixDiv.style.display = 'none';

      // Load from CSV instead of JSON
      fetch('data/step1_exchange_rates_matrix.csv')
        .then(res => res.text())
        .then(csvText => {
          const lines = csvText.trim().split('\n');
          const headers = lines[0].split(',');
          const currencies = headers.slice(2); // Skip 'date' and 'base_currency'

          // Parse CSV into matrix structure, filtered by date if specified
          const matrix = {};
          let fetchedDate = '';

          for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split(',');
            const rowDate = parts[0];
            const baseCurr = parts[1];

            // Filter by date if specified, otherwise use latest
            if (!date && i === 1) {
              fetchedDate = rowDate;
            } else if (date && rowDate !== date) {
              continue;
            } else if (date && rowDate === date && !fetchedDate) {
              fetchedDate = rowDate;
            }

            // Only include rows for the selected date (or first date if none specified)
            if (!date || rowDate === date) {
              if (!matrix[baseCurr]) {
                matrix[baseCurr] = {};
              }

              currencies.forEach((quoteCurr, idx) => {
                const rate = parseFloat(parts[idx + 2]);
                matrix[baseCurr][quoteCurr] = rate;
              });
            }
          }

          // If date filter was specified, find the actual date we're showing
          if (!fetchedDate && date) {
            fetchedDate = date;
          } else if (!fetchedDate) {
            // Get the first date from the data
            const firstRow = lines[1].split(',');
            fetchedDate = firstRow[0];
          }

          dateEl.textContent = `Exchange rates as of: ${fetchedDate}`;

          // Get base currencies from actual matrix data (preserves order from CSV)
          const baseCurrencies = Object.keys(matrix);

          // Generate thead dynamically with Date column
          const theadHtml = `
            <thead>
              <tr>
                <th style="background:#1a1a1a; position:sticky; left:0; z-index:2;">Date</th>
                <th style="background:#1a1a1a;">Base \\ Quote</th>
                ${currencies.map(curr => `<th>${curr}</th>`).join('')}
              </tr>
            </thead>
          `;

          // Generate tbody dynamically with Date column
          const tbodyHtml = `
            <tbody>
              ${baseCurrencies.map((baseCurr, idx) => `
                <tr>
                  ${idx === 0 ? `<td rowspan="${baseCurrencies.length}" style="background:#1a1a1a; position:sticky; left:0; z-index:1; vertical-align:middle; font-weight:bold; color:#00ff41;">${fetchedDate}</td>` : ''}
                  <th style="background:#1a1a1a; text-align:left; padding:8px;">${baseCurr}</th>
                  ${currencies.map(quoteCurr => {
                    const rate = matrix[baseCurr] && matrix[baseCurr][quoteCurr];
                    const displayRate = rate === 1.0 ? '‚Äî' : (rate ? rate.toFixed(4) : 'N/A');
                    const cellStyle = rate === 1.0 ? 'background:#0a0a0a; color:#555;' : '';
                    return `<td style="${cellStyle}">${displayRate}</td>`;
                  }).join('')}
                </tr>
              `).join('')}
            </tbody>
          `;

          // Replace entire table content
          table.innerHTML = theadHtml + tbodyHtml;

          loading.style.display = 'none';
          matrixDiv.style.display = 'block';
          loadedCSVs['step1'] = true;
        })
        .catch(err => {
          loading.style.display = 'block';
          loading.textContent = 'Error loading exchange rates: ' + err.message;
        });
    }

    function loadSystemConfig() {
      const loading = document.getElementById('config-loading');
      const content = document.getElementById('config-content');

      fetch('data/system_config.json')
        .then(res => res.json())
        .then(config => {
          loading.style.display = 'none';

          // Currencies
          const currencies = config.currencies || [];
          content.innerHTML = `
            <div style="margin-top:20px;">
              <h3 style="color:#00ff41; font-size:1.1em;">üìä Currencies (${currencies.length})</h3>
              <div style="padding:10px 15px; background:#0f1229; border-radius:4px; margin-top:5px;">
                <span style="color:#ccc; font-family:monospace;">${currencies.join(', ')}</span>
              </div>
            </div>
          `;

          // Estimators
          const estimators = config.horizon_estimators || {};
          const estCount = Object.keys(estimators).length;
          content.innerHTML += `
            <div style="margin-top:25px;">
              <h3 style="color:#00ff41; font-size:1.1em;">üîÆ Horizon Estimators (${estCount})</h3>
              ${Object.entries(estimators).map(([id, est]) => `
                <div style="margin-top:10px; padding:12px; background:#0f1229; border-left:3px solid #00ff41; border-radius:4px;">
                  <div style="color:#00ff41; font-weight:bold;">${id}</div>
                  <div style="color:#888; font-size:0.9em; margin-top:5px;">${est.description || ''}</div>
                  <div style="color:#666; font-size:0.85em; margin-top:8px; font-family:monospace;">
                    Type: ${est.type}<br>
                    Parameters:<br>
                    ${Object.entries(est.params || {}).map(([k, v]) => `‚Ä¢ ${k}: ${JSON.stringify(v)}`).join('<br>')}
                  </div>
                </div>
              `).join('')}
            </div>
          `;

          // Generators
          const generators = config.signal_generators || {};
          const genCount = Object.keys(generators).length;
          content.innerHTML += `
            <div style="margin-top:25px;">
              <h3 style="color:#00ff41; font-size:1.1em;">üìà Signal Generators (${genCount})</h3>
              ${Object.entries(generators).map(([id, gen]) => `
                <div style="margin-top:10px; padding:12px; background:#0f1229; border-left:3px solid #00ff41; border-radius:4px;">
                  <div style="color:#00ff41; font-weight:bold;">${id}</div>
                  <div style="color:#888; font-size:0.9em; margin-top:5px;">${gen.description || ''}</div>
                  <div style="color:#666; font-size:0.85em; margin-top:8px; font-family:monospace;">
                    Type: ${gen.type}<br>
                    Parameters:<br>
                    ${Object.entries(gen.params || {}).map(([k, v]) => `‚Ä¢ ${k}: ${JSON.stringify(v)}`).join('<br>')}
                  </div>
                </div>
              `).join('')}
            </div>
          `;

          // Strategies
          const strategies = config.strategies || {};
          const stratCount = Object.keys(strategies).length;
          content.innerHTML += `
            <div style="margin-top:25px;">
              <h3 style="color:#00ff41; font-size:1.1em;">üéØ Strategies (${stratCount})</h3>
              ${Object.entries(strategies).map(([id, strat]) => {
                const params = strat.params || {};
                return `
                  <div style="margin-top:10px; padding:12px; background:#0f1229; border-left:3px solid #00ff41; border-radius:4px;">
                    <div style="color:#00ff41; font-weight:bold;">${id}</div>
                    <div style="color:#888; font-size:0.9em; margin-top:5px;">${strat.description || ''}</div>
                    <div style="color:#666; font-size:0.85em; margin-top:8px; font-family:monospace;">
                      Type: ${strat.type}<br>
                      Parameters:<br>
                      ‚Ä¢ confidence_threshold: ${params.confidence_threshold}<br>
                      ‚Ä¢ trade_size_pct: ${params.trade_size_pct}<br>
                      ‚Ä¢ aggregation_method: ${params.aggregation_method}<br>
                      ‚Ä¢ estimator_ids: ${(params.estimator_ids || []).join(', ')}<br>
                      ‚Ä¢ generator_ids: ${(params.generator_ids || []).join(', ')}<br>
                      ‚Ä¢ generator_weights: ${params.generator_weights ? JSON.stringify(params.generator_weights) : 'N/A'}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;

          // Config file info
          content.innerHTML += `
            <div style="margin-top:25px; padding:15px; background:#1a1e3a; border:1px solid #333; border-radius:4px;">
              <h3 style="color:#00ff41; font-size:1em; margin-top:0;">‚öôÔ∏è Configuration File</h3>
              <div style="color:#888; font-size:0.9em;">
                <p>Location: <code style="color:#00ff41;">/workspace/group/fx-portfolio/config/system_config.json</code></p>
                <p>To modify: Edit the JSON file and redeploy the dashboard</p>
                <p>All modules listed in the config are active - presence in config = active</p>
              </div>
            </div>
          `;
        })
        .catch(err => {
          loading.textContent = 'Error loading configuration: ' + err.message;
        });
    }

    function loadTradesCSV() {
      const step = 'trades';
      fetch('data/step7_trades.csv')
        .then(res => res.text())
        .then(text => {
          const { headers, rows } = parseCSV(text);

          document.getElementById(`${step}-loading`).style.display = 'none';
          document.getElementById(`${step}-table`).style.display = 'table';

          // Calculate summary stats
          const totalCount = rows.length;
          const totalCost = rows.reduce((sum, r) => sum + parseFloat(r.cost_euro || 0), 0);
          const avgCost = totalCount > 0 ? totalCost / totalCount : 0;

          document.getElementById('trades-total-count').textContent = totalCount;
          document.getElementById('trades-total-cost').textContent = `‚Ç¨${totalCost.toFixed(2)}`;
          document.getElementById('trades-avg-cost').textContent = `‚Ç¨${avgCost.toFixed(2)}`;

          // Cache data for filtering
          stepDataCache[step] = { headers, allRows: rows };

          // Populate date filter
          populateDateFilter(step, rows);

          // Render table
          const thead = document.getElementById(`${step}-thead`);
          const tbody = document.getElementById(`${step}-tbody`);

          thead.innerHTML = '<tr>' + headers.map(h => `<th>${h.replace(/_/g, ' ').toUpperCase()}</th>`).join('') + '</tr>';

          tbody.innerHTML = rows.map(row => {
            return '<tr>' + headers.map(h => {
              let value = row[h];
              let className = '';

              // Color cost_euro (red)
              if (h === 'cost_euro') {
                className = 'bearish';
              }
              // Color confidence values
              else if (h.includes('confidence') && value) {
                const numVal = parseFloat(value);
                if (!isNaN(numVal)) {
                  className = numVal > 0.5 ? 'bullish' : 'neutral';
                }
              }
              // Highlight currency pairs
              else if (h === 'from_currency' || h === 'to_currency') {
                className = 'bullish';
              }

              return `<td class="${className}">${value}</td>`;
            }).join('') + '</tr>';
          }).join('');
        })
        .catch(err => {
          document.getElementById(`${step}-loading`).textContent = 'Error: ' + err.message;
          console.error('Error loading trades CSV:', err);
        });
    }

    function loadStepCountsTable() {
      fetch('data/step_counts_by_date.json')
        .then(res => res.json())
        .then(data => {
          const tableDiv = document.getElementById('step-counts-table');
          const dates = (data.dates || []).filter(d => !d.startsWith('fx-rates-'));
          const steps = data.steps || [];

          if (dates.length === 0 || steps.length === 0) {
            tableDiv.innerHTML = '<p style="color:#888;">No data available</p>';
            return;
          }

          // Pivot: dates as rows, steps as columns
          let html = '<table style="width:100%; border-collapse:collapse; font-size:0.9em;">';
          html += '<thead><tr style="background:#1a1a1a; border-bottom:2px solid #333;">';
          html += '<th style="padding:12px; text-align:left; color:#00ff41;">Date</th>';

          steps.forEach(step => {
            html += `<th style="padding:12px; text-align:center; color:#00ff41;">${step.step_name}</th>`;
          });
          html += '</tr></thead><tbody>';

          dates.forEach((date, idx) => {
            const bgColor = idx % 2 === 0 ? '#0a0a0a' : '#1a1a1a';
            html += `<tr style="background:${bgColor}; border-bottom:1px solid #222;">`;
            html += `<td style="padding:10px; color:#ccc; font-weight:bold;">${date}</td>`;

            steps.forEach(step => {
              const count = step.counts_by_date[date] || 0;
              const color = count > 0 ? '#00ff41' : '#666';
              html += `<td style="padding:10px; text-align:center; color:${color}; font-weight:bold;">${count}</td>`;
            });
            html += '</tr>';
          });

          html += '</tbody></table>';
          tableDiv.innerHTML = html;
        })
        .catch(err => {
          document.getElementById('step-counts-table').innerHTML = '<p style="color:#ff4444;">Error loading step counts</p>';
          console.error('Error loading step counts:', err);
        });
    }

    function loadTrackingDates() {
      fetch('data/tracking_dates.json')
        .then(res => res.json())
        .then(data => {
          const selector = document.getElementById('tracking-date-selector');
          const dates = data.dates || [];

          if (dates.length === 0) {
            selector.innerHTML = '<option value="">No runs available</option>';
            return;
          }

          selector.innerHTML = '<option value="">Select a date...</option>' +
            dates.map(d => {
              const statusIcon = d.status === 'success' ? '‚úì' : d.status === 'partial' ? '‚ö†Ô∏è' : '‚ùå';
              return `<option value="${d.date}">${statusIcon} ${d.date} (${d.successful_steps}/${d.total_steps} steps)</option>`;
            }).join('');

          // Add change listener
          selector.addEventListener('change', (e) => {
            const date = e.target.value;
            if (date) {
              loadTrackingLog(date);
            } else {
              document.getElementById('tracking-steps').style.display = 'none';
              document.getElementById('tracking-content').textContent = 'Select a date to view run tracking information.';
            }
          });
        })
        .catch(err => {
          document.getElementById('tracking-date-selector').innerHTML = '<option value="">Error loading dates</option>';
          console.error('Error loading tracking dates:', err);
        });
    }

    function loadTrackingLog(date) {
      const summaryEl = document.getElementById('tracking-summary');
      const contentEl = document.getElementById('tracking-content');
      const stepsEl = document.getElementById('tracking-steps');

      summaryEl.textContent = 'Loading...';
      contentEl.textContent = '';
      stepsEl.style.display = 'none';

      fetch(`data/tracking_${date}.json`)
        .then(res => res.json())
        .then(data => {
          const steps = data.steps || [];

          // Summary
          const totalDuration = steps.reduce((sum, s) => sum + (s.duration || 0), 0);
          const successCount = steps.filter(s => s.status === 'success').length;
          const failCount = steps.filter(s => s.status === 'failed').length;
          const errorCount = steps.reduce((sum, s) => sum + (s.errors || []).length, 0);
          const warnCount = steps.reduce((sum, s) => sum + (s.warnings || []).length, 0);

          summaryEl.innerHTML = `
            <span style="color:#00ff41;">${successCount} ‚úì</span>
            ${failCount > 0 ? `<span style="color:#ff4444; margin-left:10px;">${failCount} ‚ùå</span>` : ''}
            <span style="margin-left:10px;">Total: ${totalDuration.toFixed(1)}s</span>
            ${errorCount > 0 ? `<span style="color:#ff4444; margin-left:10px;">${errorCount} errors</span>` : ''}
            ${warnCount > 0 ? `<span style="color:#ff8800; margin-left:10px;">${warnCount} warnings</span>` : ''}
          `;

          contentEl.innerHTML = '';

          // Render steps
          stepsEl.innerHTML = steps.map(step => {
            const statusColor = step.status === 'success' ? '#00ff41' : step.status === 'failed' ? '#ff4444' : '#888';
            const borderColor = step.status === 'success' ? '#00ff41' : step.status === 'failed' ? '#ff4444' : '#666';

            return `
              <div style="background:#1a1a1a; border-left:3px solid ${borderColor}; border-radius:4px; padding:15px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <h3 style="color:${statusColor}; font-size:1.1em; margin:0;">
                    ${step.status_icon} ${step.step_name}
                  </h3>
                  <span style="color:#888; font-size:0.9em;">${step.duration ? step.duration.toFixed(2) + 's' : 'N/A'}</span>
                </div>

                <div style="color:#888; font-size:0.85em; margin-bottom:10px;">
                  <div>${step.start_time_display || 'N/A'} ‚Üí ${step.end_time_display || 'N/A'}</div>
                </div>

                ${Object.keys(step.counts || {}).length > 0 ? `
                  <div style="margin-top:10px;">
                    <strong style="color:#00ff41; font-size:0.9em;">Counts:</strong>
                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:8px; margin-top:5px;">
                      ${Object.entries(step.counts).map(([k, v]) => `
                        <div style="background:#0a0a0a; padding:6px 10px; border-radius:3px;">
                          <span style="color:#666; font-size:0.85em;">${k.replace(/_/g, ' ')}:</span>
                          <span style="color:#00ff41; font-weight:bold; margin-left:5px;">${v.toLocaleString()}</span>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}

                ${Object.keys(step.info || {}).length > 0 ? `
                  <div style="margin-top:10px;">
                    <strong style="color:#00ff41; font-size:0.9em;">Info:</strong>
                    <div style="color:#888; font-size:0.85em; margin-top:5px; padding:8px; background:#0a0a0a; border-radius:3px; font-family:monospace;">
                      ${Object.entries(step.info).map(([k, v]) => `
                        <div>${k}: ${v}</div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}

                ${(step.warnings || []).length > 0 ? `
                  <div style="margin-top:10px;">
                    <strong style="color:#ff8800; font-size:0.9em;">‚ö†Ô∏è Warnings (${step.warnings.length}):</strong>
                    <div style="margin-top:5px;">
                      ${step.warnings.map(w => `
                        <div style="background:#2a1a00; border-left:3px solid #ff8800; padding:8px; margin:5px 0; border-radius:3px; font-size:0.85em;">
                          ${w.message}
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}

                ${(step.errors || []).length > 0 ? `
                  <div style="margin-top:10px;">
                    <strong style="color:#ff4444; font-size:0.9em;">‚ùå Errors (${step.errors.length}):</strong>
                    <div style="margin-top:5px;">
                      ${step.errors.map(e => `
                        <div style="background:#2a0000; border-left:3px solid #ff4444; padding:8px; margin:5px 0; border-radius:3px; font-size:0.85em; font-family:monospace;">
                          ${e.message}
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>
            `;
          }).join('');

          stepsEl.style.display = 'block';
        })
        .catch(err => {
          summaryEl.textContent = '';
          contentEl.textContent = 'Error loading log: ' + err.message;
          console.error('Error loading tracking log:', err);
        });
    }

    function renderDependencyGraph(config) {
      const container = document.getElementById('dependency-graph');
      const steps = config.steps;

      // Define node positions (organized in layers by dependency depth)
      const layout = {
        '1': { x: 100, y: 50, layer: 0 },
        '3': { x: 100, y: 200, layer: 0 },
        '2': { x: 300, y: 50, layer: 1 },
        '4': { x: 300, y: 200, layer: 1 },
        '5': { x: 300, y: 280, layer: 1 },
        '6': { x: 500, y: 150, layer: 2 },
        '7': { x: 700, y: 150, layer: 3 },
        '8': { x: 900, y: 150, layer: 4 },
        '9': { x: 1100, y: 150, layer: 5 }
      };

      const nodeRadius = 35;
      const svgWidth = 1250;
      const svgHeight = 350;

      // Start building SVG
      let svg = `<svg width="${svgWidth}" height="${svgHeight}" xmlns="http://www.w3.org/2000/svg">`;

      // Define arrow marker
      svg += `
        <defs>
          <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
            <polygon points="0 0, 10 3, 0 6" fill="#00ff41" opacity="0.5" />
          </marker>
        </defs>`;

      // Draw edges (dependencies)
      Object.keys(steps).forEach(stepId => {
        const step = steps[stepId];
        const target = layout[stepId];

        step.depends_on.forEach(depId => {
          const source = layout[depId];
          if (source && target) {
            // Calculate edge endpoints (from node edge to node edge)
            const dx = target.x - source.x;
            const dy = target.y - source.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const offsetX = (dx / distance) * nodeRadius;
            const offsetY = (dy / distance) * nodeRadius;

            const x1 = source.x + offsetX;
            const y1 = source.y + offsetY;
            const x2 = target.x - offsetX;
            const y2 = target.y - offsetY;

            // Draw edge
            svg += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"
                    stroke="#00ff41" stroke-width="1.5" opacity="0.4"
                    marker-end="url(#arrowhead)" />`;
          }
        });
      });

      // Draw nodes
      Object.keys(steps).forEach(stepId => {
        const step = steps[stepId];
        const pos = layout[stepId];
        if (!pos) return;

        // Determine node color based on safety
        let fillColor = '#1a4a1a'; // Safe (green tint)
        let strokeColor = '#00ff41';
        if (!step.is_safe_to_clear) {
          fillColor = '#4a1a1a'; // Unsafe (red tint)
          strokeColor = '#ff4444';
        } else if (step.warning && step.warning.includes('LLM')) {
          fillColor = '#4a4a1a'; // LLM cost (yellow tint)
          strokeColor = '#ffaa00';
        }

        // Draw node circle
        svg += `<circle cx="${pos.x}" cy="${pos.y}" r="${nodeRadius}"
                fill="${fillColor}" stroke="${strokeColor}" stroke-width="2"
                class="graph-node" data-step="${stepId}" />`;

        // Draw step ID
        svg += `<text x="${pos.x}" y="${pos.y - 5}"
                text-anchor="middle" fill="#00ff41"
                font-family="monospace" font-size="11" font-weight="bold">
                Step ${stepId}</text>`;

        // Draw step name
        const nameWords = step.name.split(' ');
        if (nameWords.length <= 2) {
          svg += `<text x="${pos.x}" y="${pos.y + 10}"
                  text-anchor="middle" fill="#888"
                  font-family="monospace" font-size="9">
                  ${step.name}</text>`;
        } else {
          // Split into two lines for long names
          const mid = Math.ceil(nameWords.length / 2);
          const line1 = nameWords.slice(0, mid).join(' ');
          const line2 = nameWords.slice(mid).join(' ');
          svg += `<text x="${pos.x}" y="${pos.y + 6}"
                  text-anchor="middle" fill="#888"
                  font-family="monospace" font-size="8">
                  ${line1}</text>`;
          svg += `<text x="${pos.x}" y="${pos.y + 16}"
                  text-anchor="middle" fill="#888"
                  font-family="monospace" font-size="8">
                  ${line2}</text>`;
        }
      });

      svg += '</svg>';

      // Add legend
      const legend = `
        <div style="margin-top:15px; display:flex; gap:20px; justify-content:center; font-size:0.85em;">
          <div style="display:flex; align-items:center; gap:6px;">
            <div style="width:16px; height:16px; border-radius:50%; background:#1a4a1a; border:2px solid #00ff41;"></div>
            <span style="color:#888;">Safe</span>
          </div>
          <div style="display:flex; align-items:center; gap:6px;">
            <div style="width:16px; height:16px; border-radius:50%; background:#4a4a1a; border:2px solid #ffaa00;"></div>
            <span style="color:#888;">LLM Cost</span>
          </div>
          <div style="display:flex; align-items:center; gap:6px;">
            <div style="width:16px; height:16px; border-radius:50%; background:#4a1a1a; border:2px solid #ff4444;"></div>
            <span style="color:#888;">Unsafe</span>
          </div>
          <div style="display:flex; align-items:center; gap:6px;">
            <span style="color:#00ff41; font-size:1.2em;">‚Üí</span>
            <span style="color:#888;">Dependency</span>
          </div>
        </div>`;

      container.innerHTML = svg + legend;
    }

    function loadPipelineDependencies() {
      fetch('data/pipeline_steps.json')
        .then(res => res.json())
        .then(config => {
          // Render visual graph
          renderDependencyGraph(config);

          // Render detailed step info
          const container = document.getElementById('pipeline-dependencies');
          const steps = config.steps;

          // Build dependency graph visualization
          let html = '<div style="font-family:monospace; font-size:0.85em; line-height:1.8;">';

          // Sort steps by ID
          const sortedSteps = Object.keys(steps).sort((a, b) => {
            const order = ['1', '2', '3', '4', '5', '6', '7', '8', '9'];
            return order.indexOf(a) - order.indexOf(b);
          });

          sortedSteps.forEach(stepId => {
            const step = steps[stepId];
            const depends = step.depends_on || [];
            const depText = depends.length > 0 ? `‚Üê depends on: ${depends.join(', ')}` : '(root node)';

            // Determine status icon
            let icon = 'üü¢';
            if (!step.is_safe_to_clear) icon = 'üî¥';
            else if (step.warning && step.warning.includes('LLM')) icon = 'üí∞';
            else if (step.warning) icon = '‚ö†Ô∏è';

            html += `<div style="margin-bottom:12px; padding:10px; background:${stepId === '7b' ? '#2a1a1a' : '#1a1e3a'}; border:1px solid #333; border-radius:4px;">`;
            html += `<div style="color:#00ff41; font-weight:bold;">${icon} Step ${stepId}: ${step.name}</div>`;
            html += `<div style="color:#888; margin-top:4px; font-size:0.9em;">${step.description}</div>`;

            // Show script and parameters
            html += `<div style="color:#66aaff; margin-top:6px; font-size:0.85em; font-family:monospace;">`;
            html += `üìú ${step.script}`;
            if (step.supports_date_filter) {
              html += ` <span style="color:#888;">[--date YYYY-MM-DD]</span>`;
            }
            html += `</div>`;

            html += `<div style="color:#666; margin-top:4px; font-size:0.85em;">${depText}</div>`;

            if (step.warning) {
              html += `<div style="color:#ff6666; margin-top:4px; font-size:0.85em;">‚ö†Ô∏è ${step.warning}</div>`;
            }

            if (step.note) {
              html += `<div style="color:#66aaff; margin-top:4px; font-size:0.85em;">‚ÑπÔ∏è ${step.note}</div>`;
            }

            // Show outputs
            const outputs = [];
            if (step.outputs.source && step.outputs.source.length > 0) {
              outputs.push('Source: ' + step.outputs.source.join(', '));
            }
            if (step.outputs.exports && step.outputs.exports.length > 0) {
              outputs.push('Exports: ' + step.outputs.exports.join(', '));
            }
            if (outputs.length > 0) {
              html += `<div style="color:#555; margin-top:6px; font-size:0.8em; font-family:monospace;">${outputs.join(' | ')}</div>`;
            }

            html += '</div>';
          });

          html += '</div>';

          // Add orchestration commands
          html += '<div style="margin-top:20px; padding:12px; background:#1a1e3a; border:1px solid #00ff41; border-radius:4px;">';
          html += '<div style="color:#00ff41; font-weight:bold; margin-bottom:10px;">üõ†Ô∏è Orchestration Commands</div>';
          html += '<div style="color:#888; font-size:0.85em; line-height:1.8;">';
          html += '<strong style="color:#00ff41;">Dependency Resolution:</strong><br>';
          html += '<code style="color:#66aaff;">./scripts/resolve-dependencies.py --downstream 3</code> - Show what depends on step 3<br>';
          html += '<code style="color:#66aaff;">./scripts/resolve-dependencies.py --upstream 6</code> - Show what step 6 needs<br>';
          html += '<code style="color:#66aaff;">./scripts/resolve-dependencies.py --validate</code> - Validate dependency graph<br><br>';
          html += '<strong style="color:#00ff41;">Clear Data:</strong><br>';
          html += '<code style="color:#ffaa00;">./scripts/clear-data-v2.sh &lt;step&gt; --downstream --dry-run</code> - Preview clear<br>';
          html += '<code style="color:#ffaa00;">./scripts/clear-data-v2.sh 4 --downstream</code> - Clear step 4 + downstream<br><br>';
          html += '<strong style="color:#00ff41;">Rerun Steps:</strong><br>';
          html += '<code style="color:#00ff41;">./scripts/rerun-steps-v2.sh &lt;step&gt; --downstream --dry-run</code> - Preview rerun<br>';
          html += '<code style="color:#00ff41;">./scripts/rerun-steps-v2.sh 4 --downstream</code> - Rerun step 4 + downstream<br>';
          html += '<code style="color:#00ff41;">./scripts/rerun-steps-v2.sh all</code> - Run entire pipeline';
          html += '</div>';
          html += '</div>';

          container.innerHTML = html;
        })
        .catch(err => {
          document.getElementById('pipeline-dependencies').innerHTML =
            '<div style="color:#ff4444;">Error loading pipeline configuration: ' + err.message + '</div>';
        });
    }

    // Initialize dashboard - load config first, then generate tabs and load data
    function initializeDashboard() {
      document.getElementById('lastUpdate').textContent = new Date().toISOString().slice(0,19).replace('T', ' ');

      // Load pipeline config and generate tabs dynamically
      fetch('data/pipeline_steps.json')
        .then(res => res.json())
        .then(config => {
          generateDynamicTabs(config);
          generateDynamicContent(config);

          // Load data for all steps
          Object.keys(config.steps).forEach(stepId => {
            if (stepId !== '9') {  // Skip deployment step
              loadCSV(`step${stepId}`);
            }
          });

          loadStep1Dates();
          loadSystemConfig();
          loadPipelineDependencies();
          loadTrackingDates();
        })
        .catch(err => {
          console.error('Failed to load pipeline config:', err);
          // Fallback: load without dynamic generation
          ['step2', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8'].forEach(loadCSV);
          loadStep1Dates();
          loadSystemConfig();
          loadPipelineDependencies();
          loadTrackingDates();
        });
    }

    function generateDynamicTabs(config) {
      const navTabs = document.getElementById('nav-tabs');
      const trackingTab = navTabs.querySelector('[onclick*="tracking"]');

      // Generate step tabs
      const stepTabs = Object.keys(config.steps)
        .filter(id => id !== '10')  // Skip deployment step
        .sort((a, b) => {
          const order = ['1', '2', '3', '4', '5', '6', '7', '8', '9'];
          return order.indexOf(a) - order.indexOf(b);
        })
        .map(stepId => {
          const step = config.steps[stepId];
          const label = stepId === '9' ? `STEP ${stepId}: PORTFOLIOS` : `STEP ${stepId}`;
          return `<div class="tab" onclick="showTab('step${stepId}')">${label}</div>`;
        })
        .join('');

      // Insert step tabs before tracking tab
      trackingTab.insertAdjacentHTML('beforebegin', stepTabs);
    }

    function generateDynamicContent(config) {
      const trackingDiv = document.getElementById('tracking');

      // Generate content divs for each step
      Object.keys(config.steps)
        .filter(id => id !== '10')  // Skip deployment step
        .sort((a, b) => {
          const order = ['1', '2', '3', '4', '5', '6', '7', '8', '9'];
          return order.indexOf(a) - order.indexOf(b);
        })
        .forEach(stepId => {
          const step = config.steps[stepId];

          // Skip if already exists (step1 is manually defined)
          if (document.getElementById(`step${stepId}`)) return;

          const contentHtml = `
            <div id="step${stepId}" class="tab-content">
              <div class="section">
                <h2>Step ${stepId}: ${step.name} <a href="data/step${stepId}_${getDefaultFilename(stepId)}.csv" class="csv-download" download>CSV</a></h2>
                <p class="step-header">${step.description}</p>

                ${step.supports_date_filter ? `
                <!-- Date Filter -->
                <div style="margin:15px 0;">
                  <label for="step${stepId}-date-filter" style="color:#ccc; font-size:0.9em;">Filter by Date:</label>
                  <select id="step${stepId}-date-filter" style="background:#1a1a1a; color:#00ff41; border:1px solid #333; padding:6px; margin-left:10px; font-size:0.9em; border-radius:4px;">
                    <option value="">All Dates</option>
                  </select>
                </div>
                ` : ''}

                ${stepId === '9' ? generatePortfolioContent(stepId) : generateTableContent(stepId)}
              </div>
            </div>
          `;

          trackingDiv.insertAdjacentHTML('beforebegin', contentHtml);
        });
    }

    function getDefaultFilename(stepId) {
      const filenames = {
        '2': 'indices',
        '3': 'news',
        '4': 'horizons',
        '5': 'signals',
        '6': 'realization',
        '7': 'aggregated_signals',
        '8': 'trades',
        '9': 'strategies'
      };
      return filenames[stepId] || 'data';
    }

    function generateTableContent(stepId) {
      return `
        <div class="csv-table-container">
          <div class="loading" id="step${stepId}-loading">Loading...</div>
          <table id="step${stepId}-table" style="display:none;">
            <thead id="step${stepId}-thead"></thead>
            <tbody id="step${stepId}-tbody"></tbody>
          </table>
        </div>
      `;
    }

    function generatePortfolioContent(stepId) {
      return `
        <div class="chart">
          <h3 style="color:#00ff41;font-size:1em;margin-bottom:10px;">Portfolio Values by Strategy</h3>
          <div id="strategy-chart"></div>
        </div>

        <div class="csv-table-container">
          <div class="loading" id="step${stepId}-loading">Loading...</div>
          <table id="step${stepId}-table" style="display:none;">
            <thead id="step${stepId}-thead"></thead>
            <tbody id="step${stepId}-tbody"></tbody>
          </table>
        </div>

        <!-- Strategy Detail Section -->
        <div id="strategy-detail" style="display:none; margin-top:30px; padding-top:30px; border-top:1px solid #333;">
          <h3 style="color:#00ff41;font-size:1.1em;margin-bottom:15px;">Strategy Details</h3>

          <label for="strategy-selector" style="color:#ccc; font-size:0.9em;">Select Strategy:</label>
          <select id="strategy-selector" style="background:#1a1a1a; color:#00ff41; border:1px solid #333; padding:8px; margin:10px 0; font-size:1em; border-radius:4px;">
            <option value="">Choose a strategy...</option>
          </select>

          <div id="strategy-info" style="display:none;">
            <div style="margin-top:20px;">
              <h4 style="color:#00ff41; font-size:1em; margin-bottom:10px;">Currency Signals</h4>
              <div id="currency-signals" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:10px;"></div>
            </div>

            <div style="margin-top:20px;">
              <h4 style="color:#00ff41; font-size:1em; margin-bottom:10px;">Trade Recommendations</h4>
              <div id="trade-recommendations"></div>
            </div>

            <div style="margin-top:20px;">
              <h4 style="color:#00ff41; font-size:1em; margin-bottom:10px;">Portfolio Timeline</h4>
              <div id="portfolio-timeseries"></div>
            </div>
          </div>
        </div>
      `;
    }

    initializeDashboard();
  </script>
</body>
</html>